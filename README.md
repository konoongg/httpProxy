## описание 
1) http proxy
2) поддержка протокола http 1.0
3) поддерживается только метод get
4) нет поддержки https

## зависимости

```liburing```

## устанвока

### запуск 
есть стандартный ```start.sh``` который запускает прокси со стандартынми настройками.
сборка пркоси происходит с помощью  ```make```, запуск с помощью ```./httpProxy``` с указанием следующих флагов(если флаги не указаны, то берется занчение по умолчанию)

### флаги 

   ```port```  или ```-p```: Указывает порт, на котором прокси будет слушать. По умолчанию используется порт 8080.
 
   ```--max-client-threads``` или ```-t``` : Определяет максимальное количество рабочих потоков (размер пула соединений с клиентами). По умолчанию установлено 4.

  ```--help``` или ```-h``` : Выводит это справочное сообщение с описанием возможных флагов и их описаний.

   ```--cache-initial-size``` или ```-i``` : Устанавливает начальный размер кэша. По умолчанию 1 МБ. Формат: [значение][kb|mb|b] (значение и размер указываются слитно).

   ```--cache-max-size``` или ```-m``` : Устанавливает максимальный размер кэша. По умолчанию 10 МБ. Формат: [значение][kb|mb|b] (значение и размер указываются слитно).

   ```--cache-ttl``` или ```-l``` : Устанавливает время жизни записи в кэше в секундах. По умолчанию 5 секунд.

   Указывается флаг и через пробел значение, котрое хотите установить 

   ## описание принципа работы

   ### остановка программы 
   
   существует  три варианта остановить прокси 

   1) послеать ```SIGINT``` процессу - быстрая останвока без каких-либо гарантий
   2) послать ```SIGTERM``` процессу - останвока с гарантий корректного завершения рабоыт прокси, освобождения всей памяти закрытие всех файловых  декрипторов
   3) послать ```SIGQUIT``` процессу - оставновка с ожиданием заверешения выполнения всех начатых запросах (то есть есть ил вы вы уже успели установить соелинение с прокси и послали сигнал, 
      то пркоси завершит своб работу только когда ваш запрос будет обработан, данные будут отправленны серверу, будет получен ответ от сервера и отправлен вам)

  ### особенности редиректов 

  если редирект происходит на страницу поддерживающую http (не https), то прокси автоматичсеки обратиться по нужному адресу и вернет вам данные, если протокол отличен от http, то вернется сообщение о редиректе 


  ### принцип работы прокси

  прокси создает пул потоков, каждый из которых ждем подключения на указанном порту. В каждом потоке используется мультиплексирование на основе ```io_uring```, что позволяет избежать блокировок при обработке запросов. 

  ![изображение](https://github.com/user-attachments/assets/0061f89d-6a57-4bef-9c2d-85e57866b5cf)

  в рамках потока проксирвоание происходит в несколкьо этапов, каждый этап является неблокирующим

  1) ```ACCEPT``` - принятие соединение клиента, создание соекета для общения с клиентом переход в состояние READ
  2) ```READ``` - принимаются все данные, оптравленные клиентом, данные сохраняются в специальном буфере (по умолчанию размер 100кб), на случай, если все данные не придут сразу. 
      данные принимаются до того момента, пока не всетртиться последовательность ```CRLFCRLF```, то есть ```\r\n\r\n``` (признак конца get сообщения http 1.0) 
      если данных пришло больше, чем одно соединение, то остаток данных останется в буфере дял чтения, но так как http 1.0 не предполагет оптарвки двух сообщения в рамках одного соедения, нет гарантий обработки этих данных
      тут существует несколько варнитов.
    
     2.1. данные пришли все - происходит resolve доменного имени сервера, установление соединения с сервером (в текущей реализации это блокирующая операция) переход в  ```WRITE TO SERV```  
  
     2.2. если данные пришли не все то ожидается, пока не придут остальыне данные  
    
     2.3. в случае ошибки, происходит логирование и сброс всех связанных с соедлинением ресурсов  
    
   если запрос клиентский запрос содержит заголовок ```Host```, то в качестве Host в запросе к серверу будет использовано его соедримое, если указывается толкьо полный адомен сайта, то из него будет выделен Host. 
   В любом случае в запросе к серверу в качетсве домена будет укзаано ```/``` и будет содержаться заголовк ```Host```
    
  3) ```WRITE TO SERVER``` - серверу отправляются данные, полученные от клиента. Также сущесвтует три варинта, аналогчино пункту 2. в случае удачно оптравки переход в ```READ SERVER HEAD``` 
  4) ```READ SERVER HEAD``` - ожидаем получения данных от сервера, сначала считывается заголвоок, по тем же правилам, чтои в пункте 2. Далее ищется значение content-length  -
   это размер данных, которые оптравил сервер, если этого поял нет, то генерируется ошибка, если есть, то првоеряется, пришли ли нам все данные вместе с заголовком, если да, то переходим в ```WRITE```, если нет, то переходим  ```READ SERVER BODY``` 
  5) ```READ SERVER BODY``` - получаем тело ответа от сервера, аналогчино пункту 2. когда все данные получены переходи в пункт ```WRITE```
  6) ```WRITE``` -  после того, как считали все данные првоеряем статус, если статус начинается на 3 (редирект), то смотрим редирект происходит на http страницу или нет. Если да, то переходим в пукнт 3 с новым запросом  
    и с установлением нового соединением, если нет, то возвращаем содержимое. Если код сообщения отличен от редиректа то возвращаем сообщение и оптравляем данные клиенту.


диаграма перехода состояний


### огранчиения 

1) максимальное количество соединений, которые может одновременно обрабатывать один поток равно ```1024```
2) очередь ожидания подключений (```listen```) ```512```
3) максимальное количество потоков воркеров ```100```, минималньое ```1```
4) максимальный развер http сообщения, которое прокси может обработать ```100 кб```
5) пркоси ожидает, что сервер принмиает http на 80 порту

##  тесты

в папке ```t``` находится скрипт ```test.sh``` с стандартным набором тестов, попытки получить данные с сатами с большим количсетвом картинок и сайт с редиректом (так как редирект происходит на сайт с https прокси возвращает сам редирект)

все запросы осуществляютя с помощью curl, которому указывается, что надо использовать прокси 

пример

```curl -o <path to result folder>/<result file name> --http1.0 --proxy1.0 <your addres><your port> <domain>```



  
   
